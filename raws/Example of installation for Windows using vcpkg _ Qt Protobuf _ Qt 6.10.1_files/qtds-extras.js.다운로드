// Resolve preferred theme
var theme = localStorage.getItem('theme') || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
if (theme)
    document.documentElement.setAttribute('data-theme', theme);

// Page load counter
let plc = Number(localStorage.getItem('plc')) || 0;
localStorage.setItem('plc', (plc + 1) % 10)

function createCookie(name, value, days, root) {
    var params = "";
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        params = "; expires=" + date.toGMTString();
    }
    if (root)
        params += "; path=/";
    document.cookie = escape(name) + "=" + escape(value) + params;
}

function readCookie(name) {
    var nameEQ = escape(name) + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return unescape(c.substring(nameEQ.length, c.length));
    }
    return null;
}

$(function () {
    // html5 video animation play/pause controls
    $('.animation').parent().click(function () {
        var video = $(this).children(".animation").get(0);
        if (typeof video.currentSrc == 'undefined')
            return;
        var control = $(this).children(".playcontrol");
        if (video.paused) {
            control.fadeOut(); video.play();
        } else {
            control.fadeIn(); video.pause();
        }
    });
    // enable controls for animations
    $('.animation').parent().each(function() {
        var src = $(this).children(".animation").get(0).currentSrc;
        if (typeof src != 'undefined')
            $(this).children(".playcontrol").show();
    });
});

const copyContent = async (el) => {
  try {
    await navigator.clipboard.writeText(el.text().trim());
  } catch (err) {
    console.error('Failed to copy: ', err);
  }
};

const toggleWrap = () => {
    $('.pre pre').each(function() {
        if ($(this).hasClass('wrap'))
            return;
        var s = $(this).get(0).scrollWidth - $(this).innerWidth();
        $(this).parent().find('.pre-button.wrap').toggle(Math.round(s) > 0);
    });
    return toggleWrap;
};

const preButtons = `
  <div class="pre-buttons">
    <button class='pre-button wrap'
        onclick='$(this).parent().parent().children("pre:first-child").toggleClass("wrap");'
    ><i class="fa fa-exchange"></i></button>
    <button class="pre-button copy"
        onclick='copyContent($(this).parent().parent().children("pre:first-child"))'
    ><i class="fa fa-copy"></i></button>
</div>
`;

// promo banners
const promoHtml = (idx, href, img, ...v) => `
<div id="footer-promo${idx}" class="footer-promo" style="display:none;background:var(--content-bg-color);margin:0;width:100%;max-width:initial">
    <div class="container">
        <a href="${href.replace(/{([0-9])}/g, (m,i) => { return typeof v[i] === 'undefined' ? m : v[i]; })}" target="_blank"><img src="${img}" style="display:block;max-width:100%;height:auto;margin:0 auto"></a>
    </div>
</div>
`;

const addPromo = (...args) => {
    var promos = $('body > div#footer');
    $.getJSON("/.promos/promo.json", function(d) {
        for (var i = 0; i < d.promos.length; i++)
            promos.prepend(promoHtml(i, d.promos[i].href, d.promos[i].img, args));
        $(`#footer-promo${plc % d.promos.length}`).show();
    });
};

const addFloatingFeedbackElement = (url) => {
    const iconButton = $("<div></div>").attr("id", "floating-icon").css({
      width: "60px",
      height: "60px",
      position: "fixed",
      bottom: "20px",
      right: "20px",
      backgroundColor: "var(--link-color)",
      color: "#fff",
      borderRadius: "50%",
      display: "flex",
      alignItems: "center",
      justifyContent: "center",
      cursor: "pointer",
      boxShadow: "0px 4px 6px rgba(0, 0, 0, 0.1)",
      zIndex: "1000",
    });

    const svgIcon = `
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M14.5 5H10C6.68629 5 4 7.68629 4 11V17.8387L5.20278 16.8765C5.91203 16.3091 6.79328 16 7.70156 16H14.5C17.5376 16 20 13.5376 20 10.5C20 7.46243 17.5376 5 14.5 5ZM10 3C5.58172
3 2 6.58172 2 11V17.8387C2 19.5158 3.93986 20.4481 5.24939 19.4005L6.45217 18.4383C6.8068 18.1546 7.24742 18 7.70156 18H14.5C18.6421 18 22 14.6421 22 10.5C22 6.35786 18.6421 3 14.5 3H10Z" fill="currentColor" />
      </svg>`;
    iconButton.html(svgIcon);
    $("body").append(iconButton);

    const modal = $("<div></div>").attr("id", "script-modal").css({
      display: "none",
      position: "fixed",
      bottom: "90px",
      right: "20px",
      width: "400px",
      height: "700px",
      backgroundColor: "#fff",
      boxShadow: "0px 4px 6px rgba(0, 0, 0, 0.3)",
      borderRadius: "8px",
      zIndex: "1001",
      overflow: "hidden",
    });

    const closeButton = $("<div id=\"qtds-fb-close\"></div>")
        .css({
            position: "absolute",
            top: "10px",
            right: "32px",
            color: "#ddd",
            cursor: "pointer",
            zIndex: "1002",
        });

    modal.append(closeButton);
    $("body").append(modal);

    const scrollableWrapper = $("<div></div>").css({
      width: "100%",
      height: "100%",
      overflowY: "auto",
      overflowX: "hidden",
    });

    modal.append(scrollableWrapper);

    scrollableWrapper.html(`
      <iframe
          src="${url}"
          style="width: 100%; height: 100%; border: none;"
          allowfullscreen>
      </iframe>
      `);

    iconButton.on("click", (e) => {
      e.stopPropagation();
      const isVisible = modal.css("display") === "block";
      modal.css("display", isVisible ? "none" : "block");
    });

    $(document).on("click", (event) => {
      if (
        !$(event.target).closest(modal).length &&
        !$(event.target).is(iconButton)
      ) {
        modal.css("display", "none");
      }
    });

    closeButton.on("click", () => {
      modal.css("display", "none");
    });
};

$(window).on('load', function () {
    window.qtSearchNavigation = [{
            title: "Qt.io",
            value: "www.qt.io"
        }, {
            title: "Blog",
            value: "www.qt.io/blog"
        }, {
            filters: [{
                title: "All",
                value: "*"
            }, {
                title: "Qt",
                value: "qt-6/*"
            }, {
                title: "Qt Design Studio",
                value: "qtdesignstudio/*"
            }, {
                title: "Qt Creator",
                value: "qtcreator/*"
            }, {
                title: "Squish",
                value: "squish/*"
            }, {
                title: "Coco",
                value: "coco/*"
            }, {
                title: "MCUs",
                value: "QtForMCUs/*"
            }, {
                title: "Python",
                value: "qtforpython-6/*"
            }],
            title: "Documentation",
            value: "doc.qt.io"
        }, {
            title: "Wiki",
            value: "wiki.qt.io"
        }, {
            title: "Forum",
            value: "forum.qt.io"
        }];

    var docset = window.location.pathname.slice(1, window.location.pathname.lastIndexOf('/'))
    if (docset && !docset.startsWith("archives"))
        window.qtSearchNavigation[2]['filters'].splice(0,0,{'title': 'Current', 'value': docset + '/*'});

    $('.pre').append(preButtons);
    $(window).resize(toggleWrap());

    if (typeof tippy !== 'undefined') {
        tippy('.pre-button.wrap', { trigger: 'mouseenter', content: 'Toggle line wrap', appendTo: 'parent' });
        tippy('.pre-button.copy', { trigger: 'mouseenter', content: 'Copy to clipboard', appendTo: 'parent' });
        tippy('.pre-button.copy', { trigger: 'click', content: 'Copied', appendTo: 'parent',
              hideOnClick: false, onShow(t) { setTimeout(() => { t.hide(); }, 1000) }});
    }
    const pageName = encodeURIComponent(window.location.pathname);
    const feedbackLink = `https://www.surveymonkey.com/r/8XKW76J?pagename=${pageName}`;
    addPromo(pageName);

    if (!docset.startsWith('archives/'))
        addFloatingFeedbackElement(feedbackLink);
});

function resolveVersions(path) {
    var docSet = '';
    var currentVersion = '';
    if (path === undefined || path.length == 0)
        return false;
    var parts = path[1].split('-');
    if (parts.length < 2)
        currentVersion = parts[0];
    else
        currentVersion = parts.pop();
    docSet = parts.join('-');
    if (!isNaN(parseInt(docSet.slice(-1), 10)))
        docSet = docSet.slice(0,-1)
    var doc = path[path.length - 1];
    var versions = $('#qds-vdropdown');
    var ver_array = [];

    function fetchVersion(ver, curr, doc, idx, opts) {
        return new Promise(function (resolve, reject) {
            $.ajax({
                type: "HEAD",
                url: ver.root + doc,
                context: ver,
                success: function(data, success) {
                    var v = $(this).get(0);
                    var selected = v.root.endsWith(curr + '/');
                    opts.push({o: new Option(v.name, v.root, selected, selected), n:idx});
                    resolve();
                },
                error: () => { resolve(); }
            });
        });
    }

    $.getJSON("/.versions/" + docSet + ".json", function(data) {
        var promises = [];
        for (var i = 0; i < data.versions.length; i++)
            promises.push(fetchVersion(data.versions[i], currentVersion, doc, i, ver_array));

        Promise.all(promises).finally(() => {
            if (ver_array.length) {
                versions.empty();
                ver_array.sort((a,b) => a.n-b.n).forEach((v) => { versions.append(v.o) });
                versions.css('visibility', 'visible');
            }
        });
    }).fail(function() {
        return false;
    });
    return true;
}

function resolveLanguage(path) {
    var docSet = path[1] || '';
    var lang = (path.length) > 3 ? path[2] : 'en';
    $.getJSON("/.versions/" + docSet + ".tr.json", function(data) {
        const tr_html = (tr_code, tr_name, tr_class) =>
            `<li class="tr-lang${tr_class}" data-lang="${tr_code}"><a>${tr_name}</a></li>`;
        var trans = $('#qds-trans-ul');
        data.translations.forEach((t) => {
            var active = lang === t;
            try {
                let languageName = new Intl.DisplayNames([t], { type: "language" });
                trans.append(tr_html(t, languageName.of(t.split('-').at(0)), active && ' active' || ''));
            } catch (e) {
                console.error(e);
                trans.append(tr_html(t, t, active && ' active' || ''));
            }
            if (active)
                 $('li[data-lang="en"]').removeClass('active');
        });
        if (data.translations.length) {
            $('#qds-trans').css('display', 'block');
        }
    });
    return lang;
}

function handleSidebarExpand(current) {
    var nested = $('.sidebar-nav-topic').length;
    if (nested == 0)
        return;
    var toggle = $('#qds-ec-toggle');
    if (!toggle)
        return;
    $(toggle).css('display', 'block');
    $(toggle).toggleClass('expanded', current == ((1 << nested)-1));
}

function handleSidebar(path, activepage) {
    $('.c-sidebar-navigation a[href="' + activepage + '"]').parent().addClass("c-sidebar-navigation--active");
    var current = parseInt(localStorage.getItem(path)) || 0;
    handleSidebarExpand(current);
    if (current == 0)
        return;
    $('.sidebar-nav-topic').each(function() {
        var id = $(this).attr('id');
        if (id) {
            var idx = parseInt(id.slice(9));
            if (!isNaN(idx) && idx < 31)
                if (current & (1 << idx))
                    $(this).addClass('c-sidebar-navigation--open');
        }
    });
}

function populateTOC(toc) {
    if (toc.text() === "Contents") {
        var titles = $('.descr').find('h2, h3');
        toc = toc.next().children().first();
        if (toc.length && titles.length > toc.children().length) {
            toc.empty();
            titles.each(function() {
                    var h = $(this).attr('id');
                    if (!h) return;
                    var t = $(this).text();
                    var l = parseInt(this.nodeName[1] - 1);
                    toc.append(`<li class="level${l}"><p><a href="#${h}">${t}</a></p></li>`);
                });
        }
    }
}

const cloneTOC = () => {
    if (document.getElementById("qds_toc_panel"))
        return false;
    $('<div id="qds_toc_panel"><div id="qds_toc_panel_container"></div></div>')
        .appendTo('body');
    $(".b-sidebar__content__right > div").clone()
        .appendTo("#qds_toc_panel_container");
    return true;
}

const createB2T = () => {
    $('<a id="qds-b2t"><svg viewBox="0 0 20 20"><polyline points="2 13 10 5 18 13"/></svg></a>')
        .appendTo('body');
}

$(document).ready(function(){
    var path = window.location.pathname.split('/');
    var docset = path[1];
    handleSidebar(docset, path[path.length-1] + window.location.hash);
    $('.sidebar-nav-topic').each(function() {
        var id = $(this).attr('id');
        if (!id)
            return;
        var idx = parseInt(id.slice(9));
        if (isNaN(idx) || idx > 30)
            return;
        $('a:first', this).click(function() {
            var current = parseInt(localStorage.getItem(docset)) || 0;
            current = current ^ (1 << idx);
            localStorage.setItem(docset, current);
            handleSidebarExpand(current);
        });
    });

    $('#qds-ec-toggle').click(function() {
        var expand = $(this).toggleClass('expanded').hasClass('expanded');
        $('.sidebar-nav-topic').each(function() {
            $(this).toggleClass('c-sidebar-navigation--open', expand)
        });
        var state = 0;
        if (expand)
            state = (1 << $('.sidebar-nav-topic').length) - 1;
        localStorage.setItem(docset, state);
    });

    if (typeof String.prototype.endsWith !== 'function') {
        String.prototype.endsWith = function(suffix) {
            return this.indexOf(suffix, this.length - suffix.length) !== -1;
        };
    }

    var active_lang = resolveLanguage(path);
    $('#qds-trans-ul').on('click', function(e) {
        var tgt = e.target.parentNode;
        if (!tgt.classList.contains('active')) {
            var tr_path = window.location.pathname.split('/');
            if (tgt.dataset.lang == 'en')
                tr_path.splice(2, 1);
            else
                tr_path.splice(2, (active_lang == 'en') ? 0 : 1, tgt.dataset.lang);
            window.location.pathname = tr_path.join('/');
        }
    });

    $('#qds-vdropdown').on('change', function() {
        var hash = window.location.hash;
        var currentPath = window.location.pathname;
        var page = currentPath.split('/').pop();
        window.location = this.value + page + hash;
    });
    $('li.sidebar-nav-topic').css('visibility', 'visible');

    var tocHead = $('aside.b-sidebar__content__right h6').first();
    if (tocHead.length)
        populateTOC(tocHead);

    $('#qds-toc-menu').on('click', () => {
        var cloned = cloneTOC();
        $('#qds_toc_panel').addClass('active');
        setTimeout(() => {$('#qds_toc_panel a:first').focus()}, 30);
        if (cloned) {
            $('#qds_toc_panel').on('click', function(e) {
                if (e.target.id === 'qds_toc_panel' || e.target.nodeName == 'A')
                    $(this).removeClass('active');
            });
            $(document).keyup(function(e) {
                if (e.key === "Escape")
                    $('#qds_toc_panel').removeClass('active');
            });
        }
    });

    createB2T();
    $(window).scroll(function(){
        var scrollTop = $(document).scrollTop();
        $('#qds-b2t').toggleClass('active', scrollTop > 250);
        var anchors = $('div.context').find('h2,h3,h4');
        var last = -1;
        for (var i = 0; i < anchors.length; i++)
            if (scrollTop > $(anchors[i]).offset().top - 35)
                last = i;
        $('nav ul.c-tableofcontents li').removeClass('active');
        if (last == -1)
            return;
        var sel = 'nav ul.c-tableofcontents li p a[href="#' + $(anchors[last]).attr('id') + '"]';
        $(sel).parent().parent().addClass('active');
    });
    $("#qds-b2t").on('click', () => {
        $("html, body").animate({scrollTop: 0}, 500);
    });
    $('.qds-notification-banner').on('click', function() { $(this).hide(); });
});

window.onpageshow = () => {
    resolveVersions(window.location.pathname.split('/'));
}

document.addEventListener('DOMContentLoaded', function () {
    const handle = document.getElementById('qds-sbhandle');
    if (!handle)
        return;
    const toc = document.querySelector('.b-sidebar__sidebar');
    const content = document.querySelector('.b-sidebar__content');
    const height = toc.clientHeight;
    let x = 0;

    let width = localStorage.getItem('width');
    if (width) toc.style.width = width;

    new ResizeObserver((entries) => {
	handle.style.height = Math.max(entries[0].contentRect.height, height) + 230;
    }).observe(document.querySelector('.b-sidebar__sidebar__content'));

    const mouseMoveHandler = (e) => {
        let w = Math.min(Math.max(((width + e.clientX - x) * 100) /
                toc.parentNode.getBoundingClientRect().width, 5.0), 50.0);
        toc.style.width = `${w}%`;
    };

    const mouseUpHandler = () => {
        document.body.classList.remove('adjust');
        localStorage.setItem('width', toc.style.width);
        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
    };

    handle.addEventListener('mousedown', (e) => {
        document.body.classList.add('adjust');
        x = e.clientX;
        width = toc.getBoundingClientRect().width;

        document.addEventListener('mousemove', mouseMoveHandler);
        document.addEventListener('mouseup', mouseUpHandler);
    });
});
